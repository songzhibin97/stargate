# Stargate 功能文档

## 概述

Stargate 是一个高性能的 API 网关，提供路由管理、负载均衡、流量治理、认证授权等核心功能。本文档详细介绍各个功能模块的使用方法和配置选项。

## 核心功能模块

### 1. 路由管理 (Router Engine)

#### 功能描述
路由引擎负责根据请求的主机名、路径、HTTP方法等条件将请求转发到相应的后端服务。

#### 主要特性
- **多维度路由匹配**：支持基于主机名、路径、HTTP方法、请求头的路由匹配
- **路径匹配类型**：支持精确匹配、前缀匹配、正则表达式匹配
- **路由优先级**：支持路由优先级设置，高优先级路由优先匹配
- **动态路由更新**：支持运行时动态添加、更新、删除路由规则

#### 配置示例

```yaml
routes:
  - id: "api-route"
    name: "API 路由"
    priority: 100
    rules:
      hosts:
        - "api.example.com"
        - "*.api.example.com"
      paths:
        - type: "prefix"
          value: "/api/v1"
        - type: "regex"
          value: "^/api/v[0-9]+/users/[0-9]+$"
      methods:
        - "GET"
        - "POST"
        - "PUT"
        - "DELETE"
      headers:
        - name: "Content-Type"
          match_type: "regex"
          value: "application/(json|xml)"
    upstream_id: "api-upstream"
    metadata:
      description: "主要API路由"
      version: "1.0"
```

#### 使用方法

**添加路由规则**
```go
// 创建路由规则
route := &router.RouteRule{
    ID:   "user-api",
    Name: "用户API",
    Rules: router.Rule{
        Hosts:   []string{"api.example.com"},
        Paths:   []router.PathRule{{Type: "prefix", Value: "/users"}},
        Methods: []string{"GET", "POST"},
    },
    UpstreamID: "user-service",
    Priority:   100,
}

// 添加到路由引擎
err := engine.AddRoute(route)
```

**路由匹配**
```go
// 匹配请求
result, err := engine.MatchEnhanced(request)
if err != nil {
    // 处理无匹配路由的情况
}
```

### 2. 负载均衡 (Load Balancer)

#### 功能描述
负载均衡器将请求分发到多个后端服务实例，提供高可用性和性能优化。

#### 支持的算法
- **轮询 (Round Robin)**：按顺序轮流分发请求
- **加权轮询 (Weighted Round Robin)**：根据权重分发请求
- **IP哈希 (IP Hash)**：根据客户端IP哈希选择后端
- **最少连接 (Least Connections)**：选择连接数最少的后端

#### 配置示例

```yaml
upstreams:
  - id: "api-upstream"
    name: "API后端服务"
    algorithm: "weighted"
    targets:
      - url: "http://api-server-1:8080"
        weight: 70
      - url: "http://api-server-2:8080"
        weight: 30
    health_check:
      enabled: true
      path: "/health"
      interval: 30
      timeout: 5
      healthy_threshold: 2
      unhealthy_threshold: 3
```

#### 使用方法

**注册负载均衡器**
```go
manager := loadbalancer.NewManager()

// 注册不同的负载均衡算法
manager.RegisterBalancer("round_robin", &RoundRobinBalancer{})
manager.RegisterBalancer("weighted", &WeightedRoundRobinBalancer{})
manager.RegisterBalancer("ip_hash", &IPHashBalancer{})
```

**选择后端目标**
```go
target, err := manager.Select(upstream)
if err != nil {
    // 处理选择失败
}
```

### 3. 认证授权 (Authentication & Authorization)

#### 功能描述
提供多种认证方式，确保只有授权用户才能访问受保护的资源。

#### 支持的认证方式
- **API Key 认证**：基于API密钥的认证
- **JWT 认证**：基于JSON Web Token的认证
- **OAuth2 认证**：支持OAuth2协议
- **Basic 认证**：HTTP基本认证

#### 配置示例

```yaml
auth:
  enabled: true
  methods:
    api_key:
      enabled: true
      header_name: "X-API-Key"
      query_param: "api_key"
    jwt:
      enabled: true
      secret: "your-jwt-secret"
      algorithm: "HS256"
      header_name: "Authorization"
      token_prefix: "Bearer "
      claims_validation:
        required_claims:
          - "sub"
          - "exp"
        issuer: "stargate"
    oauth2:
      enabled: true
      provider_url: "https://oauth.example.com"
      client_id: "your-client-id"
      client_secret: "your-client-secret"
```

#### 使用方法

**配置认证中间件**
```go
authConfig := &auth.Config{
    Enabled: true,
    APIKey: auth.APIKeyConfig{
        Enabled:    true,
        HeaderName: "X-API-Key",
    },
    JWT: auth.JWTConfig{
        Enabled:   true,
        Secret:    "your-secret",
        Algorithm: "HS256",
    },
}

middleware := auth.NewMiddleware(authConfig)
```

**在请求中使用认证**
```bash
# API Key 认证
curl -H "X-API-Key: your-api-key" http://api.example.com/users

# JWT 认证
curl -H "Authorization: Bearer your-jwt-token" http://api.example.com/users
```

### 4. 限流控制 (Rate Limiting)

#### 功能描述
控制客户端的请求频率，防止系统过载和恶意攻击。

#### 限流策略
- **基于IP的限流**：限制单个IP的请求频率
- **基于用户的限流**：限制单个用户的请求频率
- **基于API Key的限流**：限制单个API Key的请求频率
- **全局限流**：限制整体请求频率

#### 配置示例

```yaml
rate_limit:
  enabled: true
  global:
    requests_per_second: 1000
    burst: 100
  per_ip:
    requests_per_minute: 60
    burst: 10
  per_user:
    requests_per_hour: 1000
    burst: 50
  storage:
    type: "redis"
    redis:
      addr: "localhost:6379"
      password: ""
      db: 0
```

#### 使用方法

**配置限流中间件**
```go
rateLimitConfig := &ratelimit.Config{
    Enabled: true,
    Rules: []ratelimit.Rule{
        {
            Key:               "ip",
            RequestsPerMinute: 60,
            Burst:            10,
        },
        {
            Key:              "user",
            RequestsPerHour:  1000,
            Burst:           50,
        },
    },
}

middleware := ratelimit.NewMiddleware(rateLimitConfig)
```

### 5. 熔断器 (Circuit Breaker)

#### 功能描述
当后端服务出现故障时，自动切断请求，防止故障扩散，并在服务恢复后自动恢复请求。

#### 熔断状态
- **关闭状态 (Closed)**：正常处理请求
- **打开状态 (Open)**：拒绝所有请求，返回错误
- **半开状态 (Half-Open)**：允许少量请求测试服务是否恢复

#### 配置示例

```yaml
circuit_breaker:
  enabled: true
  failure_threshold: 5        # 失败阈值
  success_threshold: 3        # 成功阈值
  timeout: 60                 # 超时时间(秒)
  recovery_timeout: 30        # 恢复超时时间(秒)
  fallback:
    enabled: true
    response:
      status: 503
      body: '{"error": "Service temporarily unavailable"}'
      headers:
        Content-Type: "application/json"
```

#### 使用方法

**配置熔断器**
```go
cbConfig := &circuitbreaker.Config{
    Enabled:          true,
    FailureThreshold: 5,
    SuccessThreshold: 3,
    Timeout:         60 * time.Second,
    RecoveryTimeout: 30 * time.Second,
}

middleware := circuitbreaker.NewMiddleware(cbConfig)
```

### 6. 健康检查 (Health Check)

#### 功能描述
定期检查后端服务的健康状态，自动剔除不健康的服务实例。

#### 检查类型
- **主动健康检查**：定期向后端发送健康检查请求
- **被动健康检查**：根据请求响应判断服务健康状态

#### 配置示例

```yaml
health_check:
  active:
    enabled: true
    path: "/health"
    interval: 30              # 检查间隔(秒)
    timeout: 5               # 超时时间(秒)
    healthy_threshold: 2     # 健康阈值
    unhealthy_threshold: 3   # 不健康阈值
    expected_status: [200, 201]
  passive:
    enabled: true
    unhealthy_status: [500, 502, 503, 504]
    unhealthy_timeout: 10
    unhealthy_threshold: 3
```

#### 使用方法

**配置健康检查**
```go
healthConfig := &health.Config{
    Active: health.ActiveConfig{
        Enabled:             true,
        Path:               "/health",
        Interval:           30 * time.Second,
        Timeout:            5 * time.Second,
        HealthyThreshold:   2,
        UnhealthyThreshold: 3,
    },
}

checker := health.NewChecker(healthConfig)
```

### 7. 流量镜像 (Traffic Mirror)

#### 功能描述
将生产流量复制到测试环境，用于测试和分析，不影响正常业务。

#### 配置示例

```yaml
traffic_mirror:
  enabled: true
  targets:
    - url: "http://test-env:8080"
      percentage: 10          # 镜像10%的流量
      async: true            # 异步镜像
    - url: "http://analytics:8080"
      percentage: 5
      conditions:
        headers:
          X-Test-User: "true"
```

#### 使用方法

**配置流量镜像**
```go
mirrorConfig := &trafficmirror.Config{
    Enabled: true,
    Targets: []trafficmirror.Target{
        {
            URL:        "http://test-env:8080",
            Percentage: 10,
            Async:      true,
        },
    },
}

middleware := trafficmirror.NewMiddleware(mirrorConfig)
```

### 8. CORS 支持

#### 功能描述
处理跨域资源共享(CORS)请求，允许浏览器跨域访问API。

#### 配置示例

```yaml
cors:
  enabled: true
  allowed_origins:
    - "https://example.com"
    - "https://*.example.com"
  allowed_methods:
    - "GET"
    - "POST"
    - "PUT"
    - "DELETE"
    - "OPTIONS"
  allowed_headers:
    - "Content-Type"
    - "Authorization"
    - "X-Requested-With"
  exposed_headers:
    - "X-Total-Count"
  allow_credentials: true
  max_age: 86400
```

### 9. IP 访问控制 (IP ACL)

#### 功能描述
基于IP地址控制访问权限，支持白名单和黑名单模式。

#### 配置示例

```yaml
ip_acl:
  enabled: true
  mode: "whitelist"          # whitelist 或 blacklist
  rules:
    - "192.168.1.0/24"       # 允许整个子网
    - "10.0.0.1"             # 允许单个IP
    - "172.16.0.0/16"        # 允许IP段
  deny_message: "Access denied from your IP address"
```

### 10. 请求/响应转换

#### 功能描述
修改请求头、响应头，添加或删除特定的HTTP头部。

#### 配置示例

```yaml
header_transform:
  enabled: true
  request:
    add:
      X-Forwarded-By: "Stargate"
      X-Request-ID: "${uuid}"
    remove:
      - "X-Internal-Token"
    replace:
      User-Agent: "Stargate-Proxy/1.0"
  response:
    add:
      X-Powered-By: "Stargate"
      X-Response-Time: "${response_time}ms"
    remove:
      - "Server"
```

## 配置管理

### 配置文件格式

Stargate 支持 YAML 和 JSON 格式的配置文件：

```yaml
# stargate.yaml
server:
  host: "0.0.0.0"
  port: 8080
  read_timeout: 30s
  write_timeout: 30s

proxy:
  timeout: 30s
  keep_alive: true
  max_idle_conns: 100

# 路由配置
routes:
  - id: "api-v1"
    name: "API v1"
    # ... 路由配置

# 上游服务配置
upstreams:
  - id: "api-service"
    name: "API Service"
    # ... 上游配置
```

### 动态配置更新

支持运行时动态更新配置，无需重启服务：

```bash
# 重新加载配置
curl -X POST http://localhost:9090/admin/reload

# 更新特定路由
curl -X PUT http://localhost:9090/admin/routes/api-v1 \
  -H "Content-Type: application/json" \
  -d '{"name": "Updated API v1", ...}'
```

## 监控和可观测性

### 指标收集

Stargate 提供丰富的监控指标：

- **请求指标**：请求数量、响应时间、错误率
- **上游指标**：上游健康状态、连接数、响应时间
- **系统指标**：CPU使用率、内存使用率、连接数

### 日志记录

支持结构化日志记录：

```yaml
logging:
  level: "info"
  format: "json"
  output: "stdout"
  fields:
    service: "stargate"
    version: "1.0.0"
```

### 链路追踪

支持分布式链路追踪：

```yaml
tracing:
  enabled: true
  provider: "jaeger"
  jaeger:
    endpoint: "http://jaeger:14268/api/traces"
    service_name: "stargate"
```

## 最佳实践

### 1. 路由设计
- 使用有意义的路由ID和名称
- 合理设置路由优先级
- 避免路由规则冲突

### 2. 负载均衡
- 根据后端服务特性选择合适的负载均衡算法
- 配置健康检查确保服务可用性
- 合理设置权重分配

### 3. 安全配置
- 启用认证和授权
- 配置适当的限流策略
- 使用HTTPS加密传输

### 4. 性能优化
- 合理配置连接池大小
- 启用Keep-Alive连接
- 配置适当的超时时间

### 5. 监控告警
- 监控关键指标
- 设置告警阈值
- 定期检查日志

## 故障排除

### 常见问题

1. **路由不匹配**
   - 检查路由规则配置
   - 验证主机名和路径匹配
   - 确认路由优先级设置

2. **后端连接失败**
   - 检查上游服务配置
   - 验证网络连通性
   - 查看健康检查状态

3. **认证失败**
   - 验证认证配置
   - 检查API Key或JWT Token
   - 确认认证方式匹配

4. **性能问题**
   - 检查系统资源使用情况
   - 优化配置参数
   - 分析请求响应时间

### 调试工具

- **健康检查端点**：`GET /health`
- **指标端点**：`GET /metrics`
- **配置查看**：`GET /admin/config`
- **路由调试**：`GET /admin/routes/debug`
